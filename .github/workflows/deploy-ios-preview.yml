name: Deploy iOS Preview

on:
    workflow_call:
        secrets:
            EXPO_TOKEN:
                required: true
            SLACK_WEBHOOK_URL:
                required: true
            APPLE_ID:
                required: true
            APPLE_TEAM_ID:
                required: true
            ASC_APP_ID:
                required: true

jobs:
    deploy-ios:
        name: "Deploy to iOS"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Set up Node.js and PNPM
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
            - name: Enable and activate pnpm via Corepack
              run: |
                  corepack enable
                  corepack prepare pnpm@8.15.5 --activate
                  pnpm -v
            - name: Install dependencies
              run: pnpm install
            - name: Verify Apple secrets are configured
              env:
                  HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name || '' }}
                  BASE_REPO: ${{ github.repository }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_APP_ID: ${{ secrets.APPLE_ID }}
                  ASC_APP_ID: ${{ secrets.ASC_APP_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
              run: |
                  missing=false

                  # APP ID may be stored under APPLE_APP_ID or ASC_APP_ID depending on convention.
                  if [ -n "$APPLE_APP_ID" ]; then
                      echo "APPLE_APP_ID is present"
                  elif [ -n "$ASC_APP_ID" ]; then
                      echo "ASC_APP_ID is present"
                  else
                      echo "Missing APP ID secret: neither APPLE_APP_ID nor ASC_APP_ID is configured"
                      missing=true
                  fi

                  if [ -z "$APPLE_ID" ]; then
                      echo "Missing APPLE_ID secret"
                      missing=true
                  else
                      echo "APPLE_ID is present"
                  fi

                  if [ -z "$APPLE_TEAM_ID" ]; then
                      echo "Missing APPLE_TEAM_ID secret"
                      missing=true
                  else
                      echo "APPLE_TEAM_ID is present"
                  fi

                  if [ "$missing" = true ]; then
                      echo "One or more required Apple secrets are missing. Please configure them in repository settings."
                      exit 1
                  fi
                  shell: bash
            - name: Confirm EAS login
              run: pnpm eas whoami
              env:
                  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
            - name: Submit to TestFlight
              run: |
                  pnpm eas submit --platform ios --profile preview --non-interactive
              env:
                  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  ASC_APP_ID: ${{ secrets.ASC_APP_ID }}
            - name: Notify Slack of build status
              uses: ./.github/actions/notify-slack
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
                  status: ${{ job.status }}
                  commit-sha: ${{ github.sha }}
                  commit-url: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
                  run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
